<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="technology, blog, linux, tcp, lambda, flink, kafka">
<meta property="og:type" content="website">
<meta property="og:title" content="Ziang&#39;s Blog">
<meta property="og:url" content="http://www.ziang.me/index.html">
<meta property="og:site_name" content="Ziang&#39;s Blog">
<meta property="og:description" content="technology, blog, linux, tcp, lambda, flink, kafka">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ziang&#39;s Blog">
<meta name="twitter:description" content="technology, blog, linux, tcp, lambda, flink, kafka">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.ziang.me/"/>





  <title>Ziang's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ziang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2018/04/30/java-exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/30/java-exception/" itemprop="url">java exception</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-30T19:57:21+08:00">
                2018-04-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>java有<code>checked</code>和<code>unchecked</code>两种类型的exception，这里的<code>check</code>可以理解为是否能提前预知的意思。<code>RuntimeException</code>是<code>unchecked</code>异常，其他异常都是<code>checked</code>异常。</p>
<p><code>checked</code>的异常是一般来说是那些肯定会发生的，不可避免的异常，所以需要调用者显式的<code>try catch</code>异常或<code>throw</code>到上层调用者处理，<code>checked</code>异常都是从<code>java.lang.Exception</code>类派生来的。</p>
<p><code>unchecked</code>异常，也就是<code>RuntimeException</code>，是指那些由编码引起的，只要调用者提前仔细检查。完全可以避免的异常，比如<code>NullPointerException</code>，<code>ArrayIndexOutOfBoundException</code>等。引用StackOverflow上一个非常好的答案：<a href="https://stackoverflow.com/questions/2190161/difference-between-java-lang-runtimeexception-and-java-lang-exception" target="_blank" rel="external">https://stackoverflow.com/questions/2190161/difference-between-java-lang-runtimeexception-and-java-lang-exception</a>，摘抄一部分如下：</p>
<pre><code>Generally RuntimeExceptions are exceptions that can be prevented programmatically. E.g NullPointerException, ArrayIndexOutOfBoundException. If you check for null before calling any method, NullPointerException would never occur. Similarly ArrayIndexOutOfBoundException would never occur if you check the index first. RuntimeException are not checked by the compiler, so it is clean code.

EDIT : These days people favor RuntimeException because the clean code it produces. It is totally a personal choice.
</code></pre><p>一个非常好的评论</p>
<pre><code>I like this angle of &quot;runtime exceptions could have been avoided by the caller&quot;. That means you (as the caller of a method) are supposed to make sure they don&apos;t even happen. Whereas checked exceptions are something that you cannot avoid and are instead required to deal with them after the fact. (And yes, since not everyone agrees with the concept of checked exceptions and many people use RuntimeException for everything, this distinction has become a bit muddled). 
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2018/02/10/flink-window/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/10/flink-window/" itemprop="url">flink window</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-10T15:43:37+08:00">
                2018-02-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>flink window</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2018/01/20/docker数据存储解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/20/docker数据存储解决方案/" itemprop="url">docker数据存储解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-20T13:35:14+08:00">
                2018-01-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h4><p>很多应用在工作的时候需要写文件，这里的文件既可能是普通的文件，也可能是内存文件。容器化后，应用写的文件都在容器的writable layer，这个layer的数据会随着容器的销毁而删除。对于无状态的应用，删除就删除了，问题不大。但如果应用有状态，比如kafka、etcd等，就需要一种方式保留数据。</p>
<h4 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h4><p>容器内的应用有共享宿主机上的目录的需求，比如telegraf希望共享/var/run/docker目录，从而可以通过unix socket看到宿主机上的其他容器，进而采集其他容器的性能数据，另外比如应用希望看到宿主机上的配置文件，也需要共享宿主机的目录。</p>
<h4 id="问题三"><a href="#问题三" class="headerlink" title="问题三"></a>问题三</h4><p>容器内的应用有临时数据需要写文件，但不要求持久化，可以容忍数据丢失，虽然可以直接写在writable layer，但性能不能满足要求，所以希望能够直接写宿主机的内存，需要提供一种方式把宿主机的内存mount到容器内的path。</p>
<p>上面的三个问题，本质需求都是宿主机和容器内应用的数据互通，docker都提供了解决方法</p>
<ul>
<li><p>问题一是把容器内的数据持久化的宿主机，可以用volume解决，创建容器的时候指定<code>-v volume_name:/path/in/container</code>，或者更加清晰的<code>--mount</code></p>
</li>
<li><p>问题二是把宿主机上的目录mount到容器内的路径，给容器内的应用读写或只读权限，可以在创建容器的时候指定<code>-v /path/in/host:/path/in/container</code>，或者更加清晰的<code>--mount</code></p>
</li>
<li><p>问题三是需要把容器内的目录映射到宿主机上的内存，可以在创建容器时指定<code>--tmpfs /path/in/container</code>，或者更加清晰的<code>--mount</code></p>
</li>
</ul>
<p>三种数据存储解决方案的区别可以简单用下图表示<img src="https://docs.docker.com/engine/admin/volumes/images/types-of-mounts.png" alt="types-of-mounts.png"></p>
<p>具体细节可以参考<a href="https://docs.docker.com/engine/admin/volumes/" target="_blank" rel="external">https://docs.docker.com/engine/admin/volumes/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2017/11/19/Docker-问题集锦/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/19/Docker-问题集锦/" itemprop="url">Docker 问题集锦</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-19T18:03:46+08:00">
                2017-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>docker engine安装完后，没有自动创建docker0 beidge interface，需要手工创建，执行下边命令即可，注意替换自己的bip网段</p>
<pre><code>sudo ip link add docker0 type bridge

sudo ip addr add 192.168.10.1/24  dev docker0  
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2017/11/12/Docker源码分析1-服务发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/12/Docker源码分析1-服务发现/" itemprop="url">Docker源码分析1-服务发现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-12T15:12:11+08:00">
                2017-11-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>在微服务大行其道的今天，我们在很多场合都听到过服务发现这个词，本文就来聊聊这个话题。</p>
<p>在讲服务发现之前，先了解下服务。基本上所有大型互联网系统都由很多组件构成，每个组件承担一部分功能，组件之间通过socket、rpc、http等方式通信，互相协作，从而构成一个完整的系统。从整体来看，系统内的每个组件既是服务提供者，也是服务消费者。</p>
<p>服务之间相互调用，肯定要先知道对方的地址，当然可以把对方地址硬编码到代码里，但对方地址变化后，依赖服务也要变更，非常麻烦。最好有一个第三方协调者，大家都把自己的地址发布到这个协调者，每个服务就都可以通过这个协调者获取到自己想要的信息了。当然，地址的发布和获取方式是服务提供者和消费者之间约定好的，并且要遵守协调者的规范。</p>
<p>既然能发布地址信息，更进一步，服务也可以发布其他的数据，比如服务自身的版本、配置等信息。但是，不管发布什么信息，对协调者来说并没有区别，仅仅是数据而已。所以抽象出来，从高层次看，第三方协调者只要能提供一个kv存储就可以了。</p>
<h3 id="服务发现项目介绍"><a href="#服务发现项目介绍" class="headerlink" title="服务发现项目介绍"></a>服务发现项目介绍</h3><p>有很多流行的开源项目都能提供服务发现能力，当然，这些项目并不仅仅用于服务发现。</p>
<ul>
<li><p><a href="https://zookeeper.apache.org/" target="_blank" rel="external">zookeeper</a> Apache开源项目，历史悠久，提供分布式的协调服务。zk抽象出了类似于文件系统的树形目录结构，client可以对树中的节点进行读写，同时提供watch、empheral node、sequence node等功能，可以用于实现分布式锁、选主、分布式队列等功能。zk可以集群部署，从而实现高可用，采用zab协议保证一致性。</p>
</li>
<li><p><a href="https://github.com/coreos/etcd" target="_blank" rel="external">etcd</a> Coreos开发的kv存储，相当于一个数据库。集群部署，具备高可用能力，用raft保证数据一致性，etcd的raft实现比较优秀，被很多开源项目采用。</p>
</li>
<li><p><a href="https://www.consul.io/" target="_blank" rel="external">consul</a> Hashicorp开发的服务发现和配置管理服务，相当于一个kv数据库。集群部署，具备高可用能力，用raft保证数据一致性。</p>
</li>
</ul>
<p>zk、etcd、consul从本质上来讲，都可以称作数据库，只不过是nosql，不提供sql语义罢了。</p>
<p>实际上mysql等关系型数据库也可以用来当做协调者，比如建一个表，只有两个字段<code>record_key</code>和<code>record_value</code>，各个服务通过读写这张表实现协调。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> kv (</div><div class="line">	record_key <span class="built_in">varchar</span>(<span class="number">256</span>),</div><div class="line">	record_value <span class="built_in">varchar</span>(<span class="number">1024</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>但mysql有个问题是没有成熟的集群方案，数据库机器是单点，如果宕机，协调者就完全不可用了。虽然可以通过主备复制实现一定程度的高可用，但主备复制存在丢数据的风险。一些互联网大厂改造了mysql，通过raft、paxos等一致性协议实现了主备之间的强同步，但成本高，一般小公司不具备这个能力。</p>
<p>另外，mysql的关系数据模型在服务发现场景基本用不到，但需要的超时自动删除，empheral节点等非常动态的功能mysql又没有，所以一般不用mysql做服务发现。</p>
<h3 id="swarm-classic的服务发现"><a href="#swarm-classic的服务发现" class="headerlink" title="swarm classic的服务发现"></a>swarm classic的服务发现</h3><p>swarm classic依赖服务发现实现动态的集群节点管理，为了支持多种服务发现backend，<code>github.com/docker/libkv</code> 这个项目抽象出了通用的kv存储层接口，任何一种kv存储，只要实现标准kv接口就可以当做swarm的service discovery backend了。标准接口如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// Store represents the backend K/V storage</span></div><div class="line"><span class="comment">// Each store should support every call listed</span></div><div class="line"><span class="comment">// here. Or it couldn't be implemented as a K/V</span></div><div class="line"><span class="comment">// backend for libkv</span></div><div class="line"><span class="keyword">type</span> Store <span class="keyword">interface</span> &#123;</div><div class="line">	<span class="comment">// Put a value at the specified key</span></div><div class="line">	Put(key <span class="keyword">string</span>, value []<span class="keyword">byte</span>, options *WriteOptions) error</div><div class="line"></div><div class="line">	<span class="comment">// Get a value given its key</span></div><div class="line">	Get(key <span class="keyword">string</span>) (*KVPair, error)</div><div class="line"></div><div class="line">	<span class="comment">// Delete the value at the specified key</span></div><div class="line">	Delete(key <span class="keyword">string</span>) error</div><div class="line"></div><div class="line">	<span class="comment">// Verify if a Key exists in the store</span></div><div class="line">	Exists(key <span class="keyword">string</span>) (<span class="keyword">bool</span>, error)</div><div class="line"></div><div class="line">	<span class="comment">// Watch for changes on a key</span></div><div class="line">	Watch(key <span class="keyword">string</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) (&lt;-<span class="keyword">chan</span> *KVPair, error)</div><div class="line"></div><div class="line">	<span class="comment">// WatchTree watches for changes on child nodes under</span></div><div class="line">	<span class="comment">// a given directory</span></div><div class="line">	WatchTree(directory <span class="keyword">string</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) (&lt;-<span class="keyword">chan</span> []*KVPair, error)</div><div class="line"></div><div class="line">	<span class="comment">// NewLock creates a lock for a given key.</span></div><div class="line">	<span class="comment">// The returned Locker is not held and must be acquired</span></div><div class="line">	<span class="comment">// with `.Lock`. The Value is optional.</span></div><div class="line">	NewLock(key <span class="keyword">string</span>, options *LockOptions) (Locker, error)</div><div class="line"></div><div class="line">	<span class="comment">// List the content of a given prefix</span></div><div class="line">	List(directory <span class="keyword">string</span>) ([]*KVPair, error)</div><div class="line"></div><div class="line">	<span class="comment">// DeleteTree deletes a range of keys under a given directory</span></div><div class="line">	DeleteTree(directory <span class="keyword">string</span>) error</div><div class="line"></div><div class="line">	<span class="comment">// Atomic CAS operation on a single value.</span></div><div class="line">	<span class="comment">// Pass previous = nil to create a new key.</span></div><div class="line">	AtomicPut(key <span class="keyword">string</span>, value []<span class="keyword">byte</span>, previous *KVPair, options *WriteOptions) (<span class="keyword">bool</span>, *KVPair, error)</div><div class="line"></div><div class="line">	<span class="comment">// Atomic delete of a single value</span></div><div class="line">	AtomicDelete(key <span class="keyword">string</span>, previous *KVPair) (<span class="keyword">bool</span>, error)</div><div class="line"></div><div class="line">	<span class="comment">// Close the store connection</span></div><div class="line">	Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>kv backend可以通过返回<code>store.ErrCallNotSupported</code> error表明自己不支持某个具体的method，比如boltdb backend就不支持<code>NewLock</code>，<code>Watch</code>，<code>WatchTree</code>等method</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// NewLock has to implemented at the library level since its not supported by BoltDB</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BoltDB)</span> <span class="title">NewLock</span><span class="params">(key <span class="keyword">string</span>, options *store.LockOptions)</span> <span class="params">(store.Locker, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, store.ErrCallNotSupported</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Watch has to implemented at the library level since its not supported by BoltDB</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BoltDB)</span> <span class="title">Watch</span><span class="params">(key <span class="keyword">string</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(&lt;-<span class="keyword">chan</span> *store.KVPair, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, store.ErrCallNotSupported</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WatchTree has to implemented at the library level since its not supported by BoltDB</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BoltDB)</span> <span class="title">WatchTree</span><span class="params">(directory <span class="keyword">string</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(&lt;-<span class="keyword">chan</span> []*store.KVPair, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, store.ErrCallNotSupported</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p><a href="https://www.digitalocean.com/community/tutorials/the-docker-ecosystem-service-discovery-and-distributed-configuration-stores" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/the-docker-ecosystem-service-discovery-and-distributed-configuration-stores</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/32806161/why-zk-etcd-over-rdbms-for-cluster-coordination" target="_blank" rel="external">https://stackoverflow.com/questions/32806161/why-zk-etcd-over-rdbms-for-cluster-coordination</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/2307029/zookeeper-chubby-vs-mysql-ndb" target="_blank" rel="external">https://stackoverflow.com/questions/2307029/zookeeper-chubby-vs-mysql-ndb</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2017/10/29/Nomad源码解析-项目结构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/29/Nomad源码解析-项目结构/" itemprop="url">Nomad源码解析-项目结构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-29T23:26:56+08:00">
                2017-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="api-package"><a href="#api-package" class="headerlink" title="api package"></a>api package</h3><p>提供访问nomad api的client结构，client封装了各种函数，用于向nomad api发起http请求。</p>
<h3 id="command-package"><a href="#command-package" class="headerlink" title="command package"></a>command package</h3><p>处理nomad的各种subcommand，调用api package中对应的函数向command/agent pacakge中的api server发起请求。</p>
<h3 id="command-agent-package"><a href="#command-agent-package" class="headerlink" title="command/agent package"></a>command/agent package</h3><p>api server，响应nomad client的请求。</p>
<h3 id="nomad-package"><a href="#nomad-package" class="headerlink" title="nomad package"></a>nomad package</h3><p>该package下以endpoint结尾的文件，都是用来处理rpc调用，nomad server主要逻辑都在该package下。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.ziang.me/2017/10/29/TCP-KeepAlive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Guo Ziang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ziang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/29/TCP-KeepAlive/" itemprop="url">TCP KeepAlive</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-29T13:43:58+08:00">
                2017-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>tcp keepalive报文，与普通tcp报文一样，只是不包含任何数据，所以tcp协议栈发送keepalive报文不会影响上层应用的数据。如果对端有应答，说明连接正常，否则，可以认为连接断开（网络或者对端的原因）。</p>
<p>tcp keepalive默认关闭，应用可以通过set socket option的方式打开，有三个内核参数会影响keepalive行为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$sudo</span> sysctl -a | grep keep</div><div class="line">net.ipv4.tcp_keepalive_intvl = 75</div><div class="line">net.ipv4.tcp_keepalive_probes = 9</div><div class="line">net.ipv4.tcp_keepalive_time = 7200</div></pre></td></tr></table></figure>
<ol>
<li><code>net.ipv4. tcp_keepalive_time</code> 最后一次发送报文的时间与第一次发送keepalive报文的间隔，即连接闲置多长时间后开始发送keepalive报文。默认为7200s，即2个小时，这个时间太长了。</li>
<li><code>net.ipv4.tcp_keepalive_intvl</code> 两次keepalive报文的间隔。</li>
<li><code>net.ipv4.tcp_keepalive_probes</code> 连续多少次keepalive报文没有回应后，认为连接已经断开。</li>
</ol>
<p>keepalive主要有两个用途：</p>
<ol>
<li>检测连接是否可用，及时发现异常情况。比如A与B之间连接，如果B突然宕机或崩溃，来不及通知A正常断开连接，所以A不知道连接已经不可用了。B重启后没有与A的连接信息，如果A发送数据包，B就会返回RST，通过keepalive报文可以及时发现这种异常情况，通知上层应用处理。</li>
<li>连接保活。现在的服务器或者网关，一般都有保护机制，如果客户端连接idle一段时间（没有发送报文），服务器会主动kill链接，释放其占用的资源。应用通过打开TCP KeepAlive选项，在没有数据传输的时候，定时向服务器发送keepalive报文，来保证连接活跃，从而不被kill。</li>
</ol>
<p>虽然keepalive能够检查连接是否存活，但更多情况下，应用层一般实现自己的心跳机制，主要原因为：</p>
<ol>
<li>keepalive只能检测连接是否正常，但心跳可以确认应用是否正常工作。keepalive是TCP/IP协议栈层面的机制，由操作系统负责，心跳工作在应用层，从更高维度上反映问题。</li>
<li>应用层可以自定义心跳发送逻辑，更加灵活，当心跳不通时，发送心跳的间隔可以指数递减，从而更快速发现问题，不用等待固定时间。</li>
<li>网络情况很复杂时，keepalive机制会失效</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html" target="_blank" rel="external">http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html</a></li>
<li><a href="http://www.tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="external">http://www.tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_e59371cc0102ux5w.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_e59371cc0102ux5w.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Guo Ziang</p>
              <p class="site-description motion-element" itemprop="description">technology, blog, linux, tcp, lambda, flink, kafka</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/truezion" target="_blank" title="Weibo">
                    
                      <i class="fa fa-fw fa-globe"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://github.com/iziang" target="_blank" title="Github">
                    
                      <i class="fa fa-fw fa-globe"></i>Github</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guo Ziang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>


<span class="post-meta-divider">|</span>

<div class="powered-by"><p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
